{% extends 'base.html' %}

{% block title %}Two-Factor Authentication - AWS FinOps Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="bi bi-shield-check text-success" style="font-size: 3rem;"></i>
                        <h2 class="mt-3 mb-1">Two-Factor Authentication</h2>
                        <p class="text-muted">Enter the 6-digit code from your authenticator app</p>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="bi bi-info-circle"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <small>
                                    Welcome back, <strong>{{ user.first_name|default:user.username }}</strong>. 
                                    Please complete the two-factor authentication to access your account.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <form method="post" data-validate novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="id_token" class="form-label">Verification Code</label>
                            <input type="text" 
                                   class="form-control form-control-lg text-center" 
                                   id="id_token" 
                                   name="token" 
                                   placeholder="000000"
                                   maxlength="6"
                                   pattern="[0-9]{6}"
                                   autocomplete="one-time-code"
                                   autofocus
                                   required
                                   style="letter-spacing: 0.5em; font-family: monospace;">
                            <div class="invalid-feedback">
                                Please enter a valid 6-digit verification code.
                            </div>
                            <div class="form-text">
                                <i class="bi bi-clock"></i> Codes expire after 30 seconds
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-shield-check"></i>
                                Verify & Continue
                            </button>
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <a href="{% url 'auth:login' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i>
                            Back to Login
                        </a>
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="bi bi-smartphone"></i>
                            Can't access your authenticator app? Contact your administrator.
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-question-circle"></i>
                        Need Help?
                    </h6>
                    <div class="accordion accordion-flush" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                    How do I find my verification code?
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>
                                        Open your authenticator app (Google Authenticator, Authy, etc.) and look for 
                                        the 6-digit code associated with "FinOps Dashboard". The code refreshes every 30 seconds.
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    What if my code doesn't work?
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>
                                        Make sure your device's time is synchronized and try a fresh code. 
                                        If problems persist, contact your system administrator for assistance.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tokenInput = document.getElementById('id_token');
    const form = document.querySelector('form[data-validate]');
    
    // Auto-format token input
    tokenInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, ''); // Remove non-digits
        
        if (value.length > 6) {
            value = value.substring(0, 6);
        }
        
        this.value = value;
        
        // Validate format
        if (value.length === 6) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            
            // Auto-submit if 6 digits entered
            setTimeout(() => {
                if (this.value.length === 6) {
                    form.submit();
                }
            }, 500);
        } else if (value.length > 0) {
            this.classList.remove('is-valid');
            if (value.length < 6) {
                this.setCustomValidity('Code must be exactly 6 digits');
            }
        } else {
            this.classList.remove('is-valid', 'is-invalid');
            this.setCustomValidity('');
        }
    });
    
    // Paste handling
    tokenInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const digits = paste.replace(/\D/g, '').substring(0, 6);
        this.value = digits;
        
        // Trigger input event
        this.dispatchEvent(new Event('input'));
    });
    
    // Form submission handling
    form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner me-2"></span>Verifying...';
        
        // Re-enable button after 10 seconds
        setTimeout(function() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }, 10000);
    });
    
    // Security: Clear token after failed attempt
    if (window.location.search.includes('error')) {
        tokenInput.value = '';
        tokenInput.focus();
    }
    
    // Progress indicator for token timeout
    let timeRemaining = 30;
    const progressBar = document.createElement('div');
    progressBar.className = 'progress mt-2';
    progressBar.style.height = '3px';
    progressBar.innerHTML = '<div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>';
    
    const formText = document.querySelector('.form-text');
    formText.appendChild(progressBar);
    
    const updateProgress = () => {
        const percentage = (timeRemaining / 30) * 100;
        const bar = progressBar.querySelector('.progress-bar');
        bar.style.width = percentage + '%';
        
        if (percentage < 25) {
            bar.classList.remove('bg-success');
            bar.classList.add('bg-warning');
        }
        
        if (percentage < 10) {
            bar.classList.remove('bg-warning');
            bar.classList.add('bg-danger');
        }
        
        timeRemaining--;
        
        if (timeRemaining < 0) {
            timeRemaining = 30;
            bar.classList.remove('bg-danger', 'bg-warning');
            bar.classList.add('bg-success');
        }
    };
    
    setInterval(updateProgress, 1000);
});
</script>
{% endblock %}
